name: Build & Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write
    packages: write

jobs:
    build_android:
        name: Build Android artifacts
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Java
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Try setup-flutter action (best-effort)
              uses: subosito/flutter-action@v2
              id: setup_subosito
              continue-on-error: true

            - name: Check flutter is installed or fallback to manual clone
              run: |
                  set -eux
                  if command -v flutter >/dev/null 2>&1; then
                    echo "flutter was installed by the previous action"
                    flutter --version
                  else
                    echo "flutter not found; performing manual clone fallback"
                    git clone --depth 1 https://github.com/flutter/flutter.git -b stable $HOME/flutter
                    echo "$HOME/flutter/bin" >> $GITHUB_PATH
                    flutter --version
                  fi
              shell: bash

            - name: Flutter pub get
              run: flutter pub get

            - name: Ensure required Android SDK components (NDK, build-tools)
              run: |
                  set -eux
                  # GitHub runners expose the SDK at /usr/local/lib/android/sdk
                  SDK_ROOT=${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}
                  echo "ANDROID_SDK_ROOT=$SDK_ROOT"
                  echo "JAVA_HOME=$JAVA_HOME"
                  java -version || true

                  # Desired NDK version requested by the project. If this changes, update accordingly.
                  NDK_VERSION=27.0.12077973

                  # Helper to attempt install with retries; cleans partial dir on failure to avoid corrupted archives
                  install_ndk() {
                    set -eu
                    echo "Installing ndk;$NDK_VERSION"
                    # retry loop
                    for i in 1 2 3; do
                      # remove any partially-extracted folder to avoid ZipException on retry
                      rm -rf "$SDK_ROOT/ndk/$NDK_VERSION" || true
                      yes | "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK_ROOT" "ndk;$NDK_VERSION" && break || {
                        echo "ndk install attempt $i failed, retrying..."
                        sleep $((i * 5))
                      }
                    done
                  }

                  # Ensure cmdline-tools exist (some images may already have them)
                  if [ ! -x "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
                    echo "cmdline-tools missing; installing..."
                    mkdir -p "$SDK_ROOT/cmdline-tools"
                    # install basic commandline tools via package manager if available; fallback to sdkmanager bundled with runner
                    # On ubuntu-latest the sdkmanager is usually present under /usr/lib/android-sdk or /usr/local/lib/android/sdk
                  fi

                  # Accept licenses (best-effort)
                  yes | "$SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK_ROOT" --licenses || true

                  # Attempt NDK install
                  install_ndk


            - name: Build APK (release)
              run: flutter build apk --release --no-tree-shake-icons

            - name: Build AAB (release)
              run: flutter build appbundle --release

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: ${{ github.ref_name }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload APK
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: build/app/outputs/flutter-apk/app-release.apk
                  asset_name: app-release.apk
                  asset_content_type: application/vnd.android.package-archive
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload AAB
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: build/app/outputs/bundle/release/app-release.aab
                  asset_name: app-release.aab
                  asset_content_type: application/octet-stream
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
