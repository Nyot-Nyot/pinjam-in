name: Build & Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write
    packages: write

jobs:
    build_android:
        name: Build Android artifacts
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Java
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Install Flutter (manual)
              run: |
                # Clone a shallow copy of the stable channel and add to PATH.
                # Using a manual install avoids resolver bugs in third-party actions
                # and gives the workflow full control over the SDK version.
                git clone --depth 1 https://github.com/flutter/flutter.git -b stable $HOME/flutter
                echo "$HOME/flutter/bin" >> $GITHUB_PATH
                flutter --version
              shell: bash

            - name: Flutter pub get
              run: flutter pub get

            - name: Build APK (release)
              run: flutter build apk --release --no-tree-shake-icons

            - name: Build AAB (release)
              run: flutter build appbundle --release

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: ${{ github.ref_name }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload APK
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: build/app/outputs/flutter-apk/app-release.apk
                  asset_name: app-release.apk
                  asset_content_type: application/vnd.android.package-archive
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload AAB
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: build/app/outputs/bundle/release/app-release.aab
                  asset_name: app-release.aab
                  asset_content_type: application/octet-stream
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
